rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Função de conveniência: verifica se o usuário está autenticado
    function isSignedIn() {
      return request.auth != null;
    }

    // ----------------------------------------------------------------------
    // 1. Pasta 'usuarios/{uid}/' (Fotos de Perfil)
    // ----------------------------------------------------------------------
    match /usuarios/{userId}/{allPaths=**} {
      // Escrita (Upload/Delete):
      // Permite que o usuário escreva APENAS dentro da sua própria pasta (/usuarios/{seu_uid}/).
      allow write: if isSignedIn() && request.auth.uid == userId;
      
      // Leitura (Download): 
      // Permite que qualquer usuário logado veja as fotos de perfil.
      allow read: if isSignedIn();
    }

    // ----------------------------------------------------------------------
    // 2. Pasta 'produtos/{allPaths=**}' (Imagens do Catálogo)
    // ----------------------------------------------------------------------
    match /produtos/{allPaths=**} {
      // Leitura (Download): 
      // As imagens de produtos são públicas.
      allow read: if true;

      // Escrita (Upload/Delete): 
      // Permite que apenas administradores façam upload e gerenciem imagens de produtos.
      // NOTA: Para usar 'isAdmin()' aqui, é necessário que o UID tenha um 'Custom Claim' 
      // configurado no Auth, pois o Storage não pode fazer o 'get' no Firestore.
      // Usaremos 'request.auth.token.admin == true' se você configurar um custom claim 'admin'.
      // Como alternativa mais simples, vou restringir a admins *logados*:
      allow write: if request.auth != null && request.auth.token.admin == true;
      
      // Se não estiver usando custom claims, a regra de Storage se torna limitada
      // e você terá que gerenciar o upload de produtos via uma Cloud Function ou Backend.
    }

    // ----------------------------------------------------------------------
    // 3. Qualquer Outro Caminho (Default)
    // ----------------------------------------------------------------------
    match /{allPaths=**} {
      // Regra de segurança padrão: Ninguém pode acessar pastas não mapeadas.
      allow read, write: if false;
    }
  }
}